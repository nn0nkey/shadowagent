# 智能路由机制说明

## 功能概述

智能路由机制决定Agent流程的下一步，根据当前状态智能选择：
- **顾问Agent**：提供策略建议
- **主攻手Agent**：执行攻击
- **工具节点**：执行工具
- **结束**：任务完成或超限

## 智能决策策略

### 1. 重复操作检测 🔄

**触发条件**：
- 相同工具连续失败3次以上

**策略**：
- 立即咨询顾问，避免无效重复
- 顾问提供新的攻击思路

**示例**：
```
❌ [execute_command] → ❌ [execute_command] → ❌ [execute_command]
→ 检测到重复操作 → 咨询顾问
```

### 2. 重复错误检测 🔄

**触发条件**：
- 相同错误类型重复3次以上（如404、403、timeout等）

**策略**：
- 识别错误模式
- 咨询顾问提供绕过方案

**示例**：
```
❌ HTTP 404 → ❌ HTTP 404 → ❌ HTTP 404
→ 检测到重复错误 → 咨询顾问
```

### 3. 动态失败阈值 📊

**策略**：
- 失败次数 < 3：每3次失败咨询一次
- 失败次数 >= 6：每2次失败咨询一次
- 失败越多，咨询越频繁

**优势**：
- 早期给主攻手更多自主空间
- 后期频繁咨询，避免无效尝试

### 4. 动态关键节点 🔄

**策略**：
- 尝试次数 < 15：每5次尝试咨询一次
- 尝试次数 >= 15：每4次尝试咨询一次
- 尝试次数 >= 30：每3次尝试咨询一次

**优势**：
- 早期定期检查，避免偏离方向
- 后期频繁检查，提高成功率

### 5. 进展检测 📈

**触发条件**：
- 最近10次操作无成功
- 尝试次数 >= 10

**策略**：
- 检测到无进展 → 立即咨询顾问
- 避免长时间无效尝试

### 6. 主动求助 🆘

**触发条件**：
- 主攻手主动请求帮助（在回复中包含 `[REQUEST_ADVISOR_HELP]`）

**策略**：
- 最高优先级
- 立即咨询顾问

## 路由流程图

```
工具执行完成
    ↓
检查是否完成 → 是 → 结束
    ↓ 否
检查是否超限 → 是 → 结束
    ↓ 否
智能模式检测
    ├─ 重复操作？ → 是 → 咨询顾问
    ├─ 重复错误？ → 是 → 咨询顾问
    └─ 否
动态阈值检查
    ├─ 连续失败达到阈值？ → 是 → 咨询顾问
    └─ 否
主动求助检查
    ├─ 主攻手请求帮助？ → 是 → 咨询顾问
    └─ 否
关键节点检查
    ├─ 达到关键节点？ → 是 → 咨询顾问
    └─ 否
进展检测
    ├─ 无进展？ → 是 → 咨询顾问
    └─ 否
默认：返回主攻手（连续攻击模式）
```

## 配置参数

在 `.env` 文件中配置：

```bash
# 智能路由
ENABLE_SMART_ROUTING=true          # 启用智能路由（默认开启）

# 失败阈值
ADVISOR_FAILURE_THRESHOLD=3        # 基础失败阈值

# 关键节点间隔
ADVISOR_CONSULTATION_INTERVAL=5    # 基础咨询间隔
```

## 优势对比

### 传统固定阈值
- ❌ 不够灵活
- ❌ 无法识别重复模式
- ❌ 可能浪费尝试次数

### 智能路由
- ✅ 动态调整阈值
- ✅ 识别重复操作和错误
- ✅ 检测进展状态
- ✅ 更高效的资源利用

## 使用示例

### 场景1：重复操作

```
尝试1: execute_command("nmap ...") → ❌
尝试2: execute_command("nmap ...") → ❌
尝试3: execute_command("nmap ...") → ❌
→ 智能路由检测到重复操作 → 咨询顾问
→ 顾问建议：尝试其他工具或方法
```

### 场景2：动态阈值

```
失败1次 → 继续
失败2次 → 继续
失败3次 → 咨询顾问（阈值3）
失败4次 → 继续
失败5次 → 继续
失败6次 → 咨询顾问（阈值变为2，每2次咨询）
失败7次 → 继续
失败8次 → 咨询顾问
```

### 场景3：无进展检测

```
尝试1-10: 全部失败，无成功
→ 智能路由检测到无进展 → 咨询顾问
→ 顾问提供新的攻击策略
```

## 日志示例

```
[Router-Tool] 🔄 检测到重复操作模式: execute_command，请求顾问帮助
[Router-Tool] 🔄 检测到重复错误模式: 404 (出现3次)，请求顾问帮助
[Router-Tool] 🆘 连续失败 6 次（阈值: 2），请求顾问帮助
[Router-Tool] ⚠️ 最近10次操作无成功，请求顾问帮助
[Router-Tool] ⚡ 工具执行完毕 → 返回主攻手（连续攻击模式，失败: 0）
```

## 未来优化

- [ ] 基于LLM的失败原因分析
- [ ] 更细粒度的错误分类
- [ ] 学习历史成功模式
- [ ] 自适应阈值调整

