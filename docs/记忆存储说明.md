# 记忆存储系统说明

## 概述

记忆存储系统参考Cyber-AutoAgent实现，提供发现、计划、反思等信息的持久化存储和检索功能。

## 功能特性

### 1. 结构化存储

支持多种类型的记忆存储：

- **finding**: 安全发现（漏洞、利用等）
- **plan**: 计划（多阶段攻击计划）
- **reflection**: 反思（策略调整、经验总结）
- **vulnerability**: 漏洞确认
- **exploit**: 利用成功
- **reconnaissance**: 侦察结果

### 2. 语义搜索

使用FAISS向量数据库进行语义搜索，支持：
- 基于内容的相似度搜索
- 类别过滤
- 元数据过滤

### 3. 自动存储

系统会自动存储：
- FLAG发现
- 可能的漏洞发现（基于关键词检测）

## 使用方法

### Agent工具调用

Agent可以通过以下工具使用记忆存储：

#### 1. 存储一般记忆

```python
store_memory(
    content="发现目标使用PHP 7.4",
    category="reconnaissance",
    metadata={"target": "example.com"}
)
```

#### 2. 存储安全发现（推荐格式）

```python
store_finding(
    vulnerability="SQL注入",
    location="/api/login",
    impact="可绕过身份验证",
    evidence="payload: admin' OR '1'='1",
    steps="1. 访问/api/login\n2. 在username参数注入payload",
    remediation="使用参数化查询",
    confidence="95%",
    severity="high"
)
```

#### 3. 存储计划

```python
store_plan(
    objective="获取FLAG",
    current_phase=1,
    total_phases=3,
    phases=[
        {
            "id": 1,
            "title": "信息收集",
            "status": "active",
            "criteria": "识别所有端点"
        },
        {
            "id": 2,
            "title": "漏洞测试",
            "status": "pending",
            "criteria": "测试SQL注入和XSS"
        },
        {
            "id": 3,
            "title": "利用",
            "status": "pending",
            "criteria": "获取FLAG"
        }
    ]
)
```

#### 4. 获取计划

```python
get_plan()  # 返回最新计划
```

#### 5. 搜索记忆

```python
retrieve_memories(
    query="SQL注入",
    category="finding",
    limit=5
)
```

#### 6. 列出记忆

```python
list_memories(
    category="finding",
    limit=10
)
```

## 存储格式

### 安全发现格式（参考Cyber-AutoAgent）

```
[VULNERABILITY] 漏洞类型
[WHERE] 位置
[IMPACT] 影响
[EVIDENCE] 证据
[STEPS] 复现步骤（可选）
[REMEDIATION] 修复建议（可选）
[CONFIDENCE] 信心水平（可选）
```

### 计划格式（JSON）

```json
{
  "objective": "目标描述",
  "current_phase": 1,
  "total_phases": 3,
  "phases": [
    {
      "id": 1,
      "title": "阶段标题",
      "status": "active|pending|done|partial_failure|blocked",
      "criteria": "完成标准"
    }
  ]
}
```

## 元数据字段

### 通用元数据

- `category`: 类别
- `severity`: 严重程度（critical/high/medium/low）
- `confidence`: 信心水平（如"95%"）
- `validation_status`: 验证状态（verified/hypothesis）
- `created_at`: 创建时间

### 发现元数据

- `severity`: 严重程度
- `confidence`: 信心水平
- `validation_status`: 验证状态
- `proof_pack`: 证据包（可选）

## 存储位置

记忆数据存储在项目根目录下的 `memory/` 目录：

```
memory/
├── memory.faiss    # FAISS向量索引
└── memory.pkl      # 元数据
```

## 自动存储机制

系统在以下情况自动存储：

1. **FLAG发现**: 当检测到FLAG时，自动存储为exploit类别
2. **漏洞发现**: 当工具输出包含漏洞关键词时，自动存储为finding类别

## 配置

记忆存储使用与知识库相同的嵌入模型：

- 默认模型: `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`
- 向量维度: 384

## 与知识库的区别

| 特性 | 知识库 | 记忆存储 |
|------|--------|----------|
| 用途 | 存储攻击场景知识（静态） | 存储运行时的发现和计划（动态） |
| 数据来源 | Markdown文档 | Agent运行过程 |
| 更新频率 | 手动添加文档 | 自动/手动存储 |
| 检索方式 | 语义搜索 | 语义搜索 + 元数据过滤 |

## 最佳实践

1. **及时存储发现**: 发现漏洞后立即使用`store_finding`存储
2. **使用结构化格式**: 使用标准格式存储，便于后续检索
3. **添加元数据**: 添加severity、confidence等元数据，便于过滤
4. **定期检索**: 在关键决策点检索相关记忆，避免重复工作
5. **计划管理**: 使用`store_plan`和`get_plan`管理多阶段攻击计划

## 示例场景

### 场景1：发现SQL注入

```python
# Agent自动检测到SQL注入
store_finding(
    vulnerability="SQL注入",
    location="/api/user?id=1",
    impact="可提取数据库敏感信息",
    evidence="payload: 1' UNION SELECT 1,2,3--",
    steps="1. 访问/api/user?id=1\n2. 注入payload",
    confidence="90%",
    severity="high"
)
```

### 场景2：检索相关记忆

```python
# 在测试新端点时，检索之前的SQL注入发现
retrieve_memories(
    query="SQL注入 /api",
    category="finding",
    limit=3
)
```

### 场景3：管理攻击计划

```python
# 开始新挑战时存储计划
store_plan(
    objective="获取FLAG",
    current_phase=1,
    total_phases=2,
    phases=[...]
)

# 在检查点获取计划
plan = get_plan()
# 评估进度，更新计划
```

## 参考

- Cyber-AutoAgent记忆系统: `agentproject/Cyber-AutoAgent-main/src/modules/tools/memory.py`
- Cyber-AutoAgent记忆文档: `agentproject/Cyber-AutoAgent-main/docs/memory.md`

