# å¯è§‚æµ‹æ€§ç³»ç»Ÿè¯´æ˜

## æ¦‚è¿°

å¯è§‚æµ‹æ€§ç³»ç»Ÿæä¾›æ“ä½œè¿½è¸ªå’Œæ€§èƒ½è¯„ä¼°åŠŸèƒ½ï¼Œå¸®åŠ©ç›‘æ§å’Œåˆ†æAgentçš„è¿è¡Œæƒ…å†µã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. æ“ä½œè¿½è¸ª

è®°å½•æ‰€æœ‰æ“ä½œçš„æ—¶é—´çº¿å’Œè¯¦ç»†ä¿¡æ¯ï¼š

- **å·¥å…·æ‰§è¡Œè¿½è¸ª**ï¼šè®°å½•æ¯æ¬¡å·¥å…·è°ƒç”¨çš„è¾“å…¥ã€è¾“å‡ºã€è€—æ—¶å’Œç»“æœ
- **Agentå†³ç­–è¿½è¸ª**ï¼šè®°å½•Agentçš„å†³ç­–è¿‡ç¨‹å’Œæ¨ç†
- **è·¯ç”±å†³ç­–è¿½è¸ª**ï¼šè®°å½•è·¯ç”±ç³»ç»Ÿçš„å†³ç­–å’ŒåŸå› 
- **FLAGå‘ç°è¿½è¸ª**ï¼šè®°å½•FLAGå‘ç°çš„æ—¶é—´å’Œå†…å®¹
- **é”™è¯¯è¿½è¸ª**ï¼šè®°å½•é”™è¯¯ä¿¡æ¯å’Œä¸Šä¸‹æ–‡

### 2. æ€§èƒ½è¯„ä¼°

æ”¶é›†å’Œè®¡ç®—æ€§èƒ½æŒ‡æ ‡ï¼š

- **æˆåŠŸç‡**ï¼šæˆåŠŸæ“ä½œå æ€»æ“ä½œçš„æ¯”ä¾‹
- **å¹³å‡å“åº”æ—¶é—´**ï¼šæ“ä½œçš„å¹³å‡è€—æ—¶
- **æ“ä½œç»Ÿè®¡**ï¼šå·¥å…·æ‰§è¡Œã€Agentå†³ç­–ã€è·¯ç”±å†³ç­–ç­‰ç»Ÿè®¡
- **Tokenä½¿ç”¨**ï¼šè¾“å…¥ã€è¾“å‡ºå’Œæ€»Tokenæ•°ç»Ÿè®¡
- **å·¥å…·ä½¿ç”¨ç»Ÿè®¡**ï¼šå„å·¥å…·çš„ä½¿ç”¨é¢‘ç‡

### 3. æŒ‡æ ‡æŠ¥å‘Š

è‡ªåŠ¨ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šï¼ŒåŒ…å«ï¼š

- æ ¸å¿ƒæŒ‡æ ‡æ±‡æ€»
- æ“ä½œç»Ÿè®¡è¯¦æƒ…
- Tokenä½¿ç”¨æƒ…å†µ
- å·¥å…·ä½¿ç”¨åˆ†æ

## æ•°æ®ç»“æ„

### OperationTraceï¼ˆæ“ä½œè¿½è¸ªï¼‰

```python
{
    "timestamp": 1234567890.123,
    "datetime": "2024-01-15T10:30:00",
    "operation_type": "tool_execution",
    "operation_id": "tool_1234567890",
    "agent_name": "attacker",
    "tool_name": "execute_command",
    "input_data": {...},
    "output_data": {...},
    "duration_ms": 123.45,
    "success": true,
    "error_message": null,
    "metadata": {...}
}
```

### PerformanceMetricsï¼ˆæ€§èƒ½æŒ‡æ ‡ï¼‰

```python
{
    "total_operations": 100,
    "successful_operations": 85,
    "failed_operations": 15,
    "success_rate": 0.85,
    "total_duration_ms": 5000.0,
    "average_duration_ms": 50.0,
    "tool_executions": 60,
    "agent_decisions": 30,
    "router_decisions": 10,
    "flags_found": 1,
    "errors": 15,
    "token_usage": {
        "input_tokens": 10000,
        "output_tokens": 5000,
        "total_tokens": 15000
    }
}
```

## æ“ä½œç±»å‹

ç³»ç»Ÿè¿½è¸ªä»¥ä¸‹æ“ä½œç±»å‹ï¼š

- `tool_execution`: å·¥å…·æ‰§è¡Œ
- `agent_decision`: Agentå†³ç­–
- `router_decision`: è·¯ç”±å†³ç­–
- `state_update`: çŠ¶æ€æ›´æ–°
- `flag_found`: FLAGå‘ç°
- `error`: é”™è¯¯

## å­˜å‚¨ä½ç½®

å¯è§‚æµ‹æ€§æ•°æ®å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `observability/<operation_id>/` ç›®å½•ï¼š

```
observability/
â””â”€â”€ <operation_id>/
    â”œâ”€â”€ traces.json      # æ“ä½œè¿½è¸ªæ•°æ®
    â”œâ”€â”€ metrics.json    # æ€§èƒ½æŒ‡æ ‡æ•°æ®
    â””â”€â”€ report.txt      # æ€§èƒ½æŠ¥å‘Š
```

## ä½¿ç”¨ç¤ºä¾‹

### è‡ªåŠ¨è¿½è¸ª

ç³»ç»Ÿä¼šè‡ªåŠ¨è¿½è¸ªæ‰€æœ‰æ“ä½œï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼š

```python
# åœ¨main.pyä¸­åˆå§‹åŒ–
operation_id = f"{challenge_id}_{int(time.time())}"
tracker = initialize_tracker(operation_id)

# è¿è¡ŒAgent...
# ç³»ç»Ÿè‡ªåŠ¨è¿½è¸ªæ‰€æœ‰æ“ä½œ

# ç»“æŸæ—¶ä¿å­˜æ•°æ®
tracker.finalize()
```

### æ‰‹åŠ¨è®°å½•

å¦‚æœéœ€è¦æ‰‹åŠ¨è®°å½•ç‰¹å®šæ“ä½œï¼š

```python
from src.utils.observability import get_tracker, OperationType

tracker = get_tracker()
if tracker:
    # è®°å½•å·¥å…·æ‰§è¡Œ
    tracker.record_tool_execution(
        tool_name="execute_command",
        input_data={"command": "nmap -sV target"},
        output_data={"result": "..."},
        success=True,
        duration_ms=123.45
    )
    
    # è®°å½•Agentå†³ç­–
    tracker.record_agent_decision(
        agent_name="attacker",
        decision="ä½¿ç”¨SQLæ³¨å…¥æ”»å‡»",
        reasoning="ç›®æ ‡å¯èƒ½å­˜åœ¨SQLæ³¨å…¥æ¼æ´"
    )
    
    # è®°å½•è·¯ç”±å†³ç­–
    tracker.record_router_decision(
        decision="advisor",
        reason="è¿ç»­å¤±è´¥3æ¬¡",
        metadata={"consecutive_failures": 3}
    )
    
    # è®°å½•FLAGå‘ç°
    tracker.record_flag_found("flag{test123}")
    
    # è®°å½•Tokenä½¿ç”¨
    tracker.record_token_usage(
        input_tokens=1000,
        output_tokens=500
    )
```

## æ€§èƒ½æŠ¥å‘Šç¤ºä¾‹

```
============================================================
ğŸ“Š æ€§èƒ½è¯„ä¼°æŠ¥å‘Š
============================================================
æ“ä½œID: challenge_001_1234567890
å¼€å§‹æ—¶é—´: 2024-01-15 10:30:00
æ€»æ—¶é•¿: 120.50 ç§’

ğŸ“ˆ æ ¸å¿ƒæŒ‡æ ‡
------------------------------------------------------------
æ€»æ“ä½œæ•°: 100
æˆåŠŸæ“ä½œ: 85
å¤±è´¥æ“ä½œ: 15
æˆåŠŸç‡: 85.00%
å¹³å‡å“åº”æ—¶é—´: 50.00 ms

ğŸ”§ æ“ä½œç»Ÿè®¡
------------------------------------------------------------
å·¥å…·æ‰§è¡Œ: 60
Agentå†³ç­–: 30
è·¯ç”±å†³ç­–: 10
FLAGå‘ç°: 1
é”™è¯¯æ•°: 15

ğŸ’» Tokenä½¿ç”¨
------------------------------------------------------------
è¾“å…¥Token: 10,000
è¾“å‡ºToken: 5,000
æ€»Token: 15,000

ğŸ› ï¸ å·¥å…·ä½¿ç”¨ç»Ÿè®¡
------------------------------------------------------------
  execute_command: 30 æ¬¡
  execute_python_poc: 20 æ¬¡
  submit_flag: 10 æ¬¡

============================================================
```

## é…ç½®

å¯è§‚æµ‹æ€§ç³»ç»Ÿé»˜è®¤å¯ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

å¦‚æœéœ€è¦ç¦ç”¨ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­ä¸åˆå§‹åŒ–è¿½è¸ªå™¨ã€‚

## ä¸Cyber-AutoAgentçš„å¯¹æ¯”

| ç‰¹æ€§ | MyAgent | Cyber-AutoAgent |
|------|---------|----------------|
| æ“ä½œè¿½è¸ª | âœ… æœ¬åœ°JSON | âœ… Langfuse |
| æ€§èƒ½è¯„ä¼° | âœ… åŸºç¡€æŒ‡æ ‡ | âœ… Ragasè¯„ä¼° |
| å¯è§†åŒ– | âœ… æ–‡æœ¬æŠ¥å‘Š | âœ… Web UI |
| å®æ—¶ç›‘æ§ | âŒ | âœ… |
| å¤–éƒ¨ä¾èµ– | âŒ | âœ… (Langfuse) |

## æœ€ä½³å®è·µ

1. **å®šæœŸæŸ¥çœ‹æŠ¥å‘Š**ï¼šè¿è¡Œå®ŒæˆåæŸ¥çœ‹æ€§èƒ½æŠ¥å‘Šï¼Œäº†è§£Agentè¡¨ç°
2. **åˆ†æå¤±è´¥æ“ä½œ**ï¼šæŸ¥çœ‹å¤±è´¥çš„æ“ä½œè¿½è¸ªï¼Œæ‰¾å‡ºé—®é¢˜åŸå› 
3. **ä¼˜åŒ–å·¥å…·ä½¿ç”¨**ï¼šæ ¹æ®å·¥å…·ä½¿ç”¨ç»Ÿè®¡ï¼Œä¼˜åŒ–å·¥å…·é€‰æ‹©ç­–ç•¥
4. **ç›‘æ§Tokenä½¿ç”¨**ï¼šå…³æ³¨Tokenæ¶ˆè€—ï¼Œä¼˜åŒ–æç¤ºè¯å’Œä¸Šä¸‹æ–‡

## æœªæ¥æ”¹è¿›

- [ ] å®æ—¶ç›‘æ§å’Œå¯è§†åŒ–
- [ ] æ›´è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚å·¥å…·é€‰æ‹©å‡†ç¡®æ€§ï¼‰
- [ ] ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼ˆå¦‚Langfuseï¼‰
- [ ] è‡ªåŠ¨æ€§èƒ½ä¼˜åŒ–å»ºè®®

